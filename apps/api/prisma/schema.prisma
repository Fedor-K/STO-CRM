generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ===== Enums =====

enum UserRole {
  SUPERADMIN
  OWNER
  MANAGER
  RECEPTIONIST
  MECHANIC
  CLIENT
}

enum AppointmentStatus {
  PENDING
  ESTIMATING
  CONFIRMED
  IN_PROGRESS
  COMPLETED
  CANCELLED
  NO_SHOW
}

enum WorkOrderStatus {
  NEW
  DIAGNOSED
  APPROVED
  IN_PROGRESS
  PAUSED
  COMPLETED
  INVOICED
  PAID
  CLOSED
  CANCELLED
}

enum WorkOrderItemType {
  LABOR
  PART
}

enum StockMovementType {
  PURCHASE
  CONSUMPTION
  RETURN
  ADJUSTMENT
  RESERVED
}

enum TransactionType {
  INCOME
  EXPENSE
}

enum RecommendationType {
  PRIMARY
  SECONDARY
}

enum RecommendationStatus {
  PENDING
  DONE
  DEFERRED
  DECLINED
}

enum PhotoType {
  INTAKE
  DIAGNOSTIC
  PROGRESS
  COMPLETION
}

enum FollowUpResult {
  DONE
  RESCHED
  DECLINE
  NO_ANSWER
}

enum ServiceUsage {
  PLANNING
  PRODUCTION
  BOTH
}

enum PurchaseOrderStatus {
  DRAFT
  ORDERED
  PARTIALLY_RECEIVED
  RECEIVED
  CANCELLED
}

// ===== Models =====

model Tenant {
  id        String   @id @default(uuid())
  name      String
  slug      String   @unique
  settings  Json     @default("{}")
  plan      String   @default("basic")
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  users          User[]
  vehicles       Vehicle[]
  services       Service[]
  repairTypes    RepairType[]
  appointments   Appointment[]
  workOrders     WorkOrder[]
  parts          Part[]
  purchaseOrders PurchaseOrder[]
  transactions   Transaction[]

  @@map("tenants")
}

model User {
  id           String   @id @default(uuid())
  email        String
  passwordHash String
  role         UserRole
  firstName    String
  lastName     String
  middleName   String?
  dateOfBirth  DateTime?
  phone        String?
  isActive     Boolean  @default(true)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  tenantId String
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  refreshTokens          RefreshToken[]
  vehicles               Vehicle[]              @relation("ClientVehicles")
  appointmentsAsClient   Appointment[]          @relation("AppointmentClient")
  appointmentsAsAdvisor  Appointment[]          @relation("AppointmentAdvisor")
  workOrdersAsClient     WorkOrder[]            @relation("WorkOrderClient")
  workOrdersAsAdvisor    WorkOrder[]            @relation("WorkOrderAdvisor")
  workOrdersAsMechanic   WorkOrder[]            @relation("WorkOrderMechanic")
  workLogs               WorkLog[]
  followUps              FollowUp[]

  @@unique([email, tenantId])
  @@unique([phone, tenantId])
  @@index([tenantId])
  @@map("users")
}

model RefreshToken {
  id        String   @id @default(uuid())
  token     String   @unique
  expiresAt DateTime
  createdAt DateTime @default(now())

  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([expiresAt])
  @@map("refresh_tokens")
}

model Vehicle {
  id           String   @id @default(uuid())
  make         String
  model        String
  year         Int?
  vin          String?
  licensePlate String?
  color        String?
  mileage      Int?
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  tenantId String
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  clientId String
  client   User   @relation("ClientVehicles", fields: [clientId], references: [id], onDelete: Cascade)

  appointments Appointment[]
  workOrders   WorkOrder[]

  @@unique([vin, tenantId])
  @@unique([licensePlate, tenantId])
  @@index([tenantId])
  @@index([clientId])
  @@map("vehicles")
}

model Service {
  id               String       @id @default(uuid())
  name             String
  description      String?
  price            Decimal      @db.Decimal(12, 2)
  estimatedMinutes Int          @default(60)
  normHours        Decimal?     @db.Decimal(6, 2)
  complexityLevel  Int          @default(1)
  serviceUsage     ServiceUsage @default(BOTH)
  isActive         Boolean      @default(true)
  createdAt        DateTime     @default(now())
  updatedAt        DateTime     @updatedAt

  tenantId String
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  workOrderItems WorkOrderItem[]

  @@index([tenantId])
  @@map("services")
}

model RepairType {
  id             String  @id @default(uuid())
  name           String
  isPaid         Boolean @default(true)
  affectsRevenue Boolean @default(true)

  tenantId String
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  workOrders WorkOrder[]

  @@index([tenantId])
  @@map("repair_types")
}

model Appointment {
  id             String            @id @default(uuid())
  scheduledStart DateTime
  scheduledEnd   DateTime
  status         AppointmentStatus @default(PENDING)
  source         String?
  adChannel      String?
  notes          String?
  cancelReason   String?
  cancelComment  String?
  cancelledFrom  String?
  plannedItems   Json?
  createdAt      DateTime          @default(now())
  updatedAt      DateTime          @updatedAt

  tenantId String
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  clientId String
  client   User   @relation("AppointmentClient", fields: [clientId], references: [id])

  advisorId String?
  advisor   User?   @relation("AppointmentAdvisor", fields: [advisorId], references: [id])

  vehicleId String
  vehicle   Vehicle @relation(fields: [vehicleId], references: [id])

  workOrder WorkOrder?

  @@index([tenantId])
  @@index([clientId])
  @@index([scheduledStart])
  @@index([status])
  @@map("appointments")
}

model WorkOrder {
  id               String          @id @default(uuid())
  orderNumber      String
  status           WorkOrderStatus @default(NEW)
  clientComplaints String?
  diagnosticNotes  String?
  inspectionChecklist Json?
  totalLabor       Decimal         @default(0) @db.Decimal(12, 2)
  totalParts       Decimal         @default(0) @db.Decimal(12, 2)
  totalAmount      Decimal         @default(0) @db.Decimal(12, 2)
  approvedAmount   Decimal?        @db.Decimal(12, 2)
  mileageAtIntake  Int?
  fuelLevel        String?
  createdAt        DateTime        @default(now())
  updatedAt        DateTime        @updatedAt
  completedAt      DateTime?
  paidAt           DateTime?

  tenantId String
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  clientId String
  client   User   @relation("WorkOrderClient", fields: [clientId], references: [id])

  advisorId String?
  advisor   User?   @relation("WorkOrderAdvisor", fields: [advisorId], references: [id])

  mechanicId String?
  mechanic   User?   @relation("WorkOrderMechanic", fields: [mechanicId], references: [id])

  vehicleId String
  vehicle   Vehicle @relation(fields: [vehicleId], references: [id])

  repairTypeId String?
  repairType   RepairType? @relation(fields: [repairTypeId], references: [id])

  appointmentId String?      @unique
  appointment   Appointment? @relation(fields: [appointmentId], references: [id])

  items           WorkOrderItem[]
  workLogs        WorkLog[]
  photos          WorkOrderPhoto[]
  recommendations Recommendation[]
  followUps       FollowUp[]
  transactions    Transaction[]

  @@unique([orderNumber, tenantId])
  @@index([tenantId])
  @@index([clientId])
  @@index([mechanicId])
  @@index([status])
  @@index([createdAt])
  @@map("work_orders")
}

model WorkOrderItem {
  id          String            @id @default(uuid())
  type        WorkOrderItemType
  description String
  quantity    Decimal           @default(1) @db.Decimal(10, 2)
  unitPrice   Decimal           @db.Decimal(12, 2)
  totalPrice  Decimal           @db.Decimal(12, 2)
  normHours        Decimal?  @db.Decimal(6, 2)
  recommended      Boolean   @default(false)
  approvedByClient Boolean?
  createdAt        DateTime  @default(now())

  workOrderId String
  workOrder   WorkOrder @relation(fields: [workOrderId], references: [id], onDelete: Cascade)

  serviceId String?
  service   Service? @relation(fields: [serviceId], references: [id])

  partId String?
  part   Part?   @relation(fields: [partId], references: [id])

  @@index([workOrderId])
  @@map("work_order_items")
}

model WorkLog {
  id          String   @id @default(uuid())
  description String?
  hoursWorked Decimal  @db.Decimal(6, 2)
  logDate     DateTime @default(now())
  createdAt   DateTime @default(now())

  workOrderId String
  workOrder   WorkOrder @relation(fields: [workOrderId], references: [id], onDelete: Cascade)

  mechanicId String
  mechanic   User   @relation(fields: [mechanicId], references: [id])

  @@index([workOrderId])
  @@index([mechanicId])
  @@map("work_logs")
}

model WorkOrderPhoto {
  id        String    @id @default(uuid())
  url       String
  type      PhotoType
  caption   String?
  createdAt DateTime  @default(now())

  workOrderId String
  workOrder   WorkOrder @relation(fields: [workOrderId], references: [id], onDelete: Cascade)

  @@index([workOrderId])
  @@map("work_order_photos")
}

model Recommendation {
  id            String               @id @default(uuid())
  type          RecommendationType
  description   String
  photoUrl      String?
  videoUrl      String?
  estimatedCost Decimal?             @db.Decimal(12, 2)
  dueMileage    Int?
  dueDate       DateTime?
  status        RecommendationStatus @default(PENDING)
  createdAt     DateTime             @default(now())
  updatedAt     DateTime             @updatedAt

  workOrderId String
  workOrder   WorkOrder @relation(fields: [workOrderId], references: [id], onDelete: Cascade)

  @@index([workOrderId])
  @@map("recommendations")
}

model FollowUp {
  id          String        @id @default(uuid())
  scheduledAt DateTime
  result      FollowUpResult?
  notes       String?
  completedAt DateTime?
  createdAt   DateTime      @default(now())

  workOrderId String
  workOrder   WorkOrder @relation(fields: [workOrderId], references: [id], onDelete: Cascade)

  assignedToId String
  assignedTo   User   @relation(fields: [assignedToId], references: [id])

  @@index([workOrderId])
  @@index([assignedToId])
  @@index([scheduledAt])
  @@map("follow_ups")
}

model Part {
  id           String   @id @default(uuid())
  sku          String?
  name         String
  brand        String?
  oemNumber    String?
  costPrice    Decimal  @db.Decimal(12, 2)
  sellPrice    Decimal  @db.Decimal(12, 2)
  currentStock Int      @default(0)
  minStock     Int      @default(0)
  unit         String   @default("шт")
  isActive     Boolean  @default(true)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  tenantId String
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  workOrderItems    WorkOrderItem[]
  stockMovements    StockMovement[]
  purchaseOrderItems PurchaseOrderItem[]

  @@index([tenantId])
  @@index([sku])
  @@index([oemNumber])
  @@map("parts")
}

model StockMovement {
  id        String            @id @default(uuid())
  type      StockMovementType
  quantity  Int
  reference String?
  notes     String?
  createdAt DateTime          @default(now())

  partId String
  part   Part   @relation(fields: [partId], references: [id], onDelete: Cascade)

  @@index([partId])
  @@index([type])
  @@map("stock_movements")
}

model PurchaseOrder {
  id         String              @id @default(uuid())
  number     String
  supplier   String
  status     PurchaseOrderStatus @default(DRAFT)
  totalCost  Decimal             @default(0) @db.Decimal(12, 2)
  notes      String?
  orderedAt  DateTime?
  receivedAt DateTime?
  createdAt  DateTime            @default(now())
  updatedAt  DateTime            @updatedAt

  tenantId String
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  items PurchaseOrderItem[]

  @@index([tenantId])
  @@map("purchase_orders")
}

model PurchaseOrderItem {
  id          String  @id @default(uuid())
  quantity    Int
  unitCost    Decimal @db.Decimal(12, 2)
  totalCost   Decimal @db.Decimal(12, 2)
  received    Int     @default(0)

  purchaseOrderId String
  purchaseOrder   PurchaseOrder @relation(fields: [purchaseOrderId], references: [id], onDelete: Cascade)

  partId String
  part   Part   @relation(fields: [partId], references: [id])

  @@index([purchaseOrderId])
  @@map("purchase_order_items")
}

model Transaction {
  id          String          @id @default(uuid())
  type        TransactionType
  amount      Decimal         @db.Decimal(12, 2)
  category    String?
  description String?
  date        DateTime        @default(now())
  createdAt   DateTime        @default(now())

  tenantId String
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  workOrderId String?
  workOrder   WorkOrder? @relation(fields: [workOrderId], references: [id])

  @@index([tenantId])
  @@index([type])
  @@index([date])
  @@map("transactions")
}
