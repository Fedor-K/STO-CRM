# SaaS-платформа для автосервисов (СТО)

## Технологический стек

| Слой | Технология | Почему |
|------|-----------|--------|
| **Backend** | NestJS + TypeScript | Модульная структура, DI, guards для RBAC, Swagger из коробки |
| **ORM** | Prisma 5 | Type-safe, миграции, schema-as-code |
| **БД** | PostgreSQL 16 | Надёжность, RLS для доп. изоляции тенантов |
| **Кэш/очереди** | Redis + BullMQ | Сессии, фоновые задачи (уведомления, отчёты) |
| **Frontend** | Next.js 14 (App Router) | SSR, route groups для admin/client порталов |
| **UI** | shadcn/ui + Tailwind CSS | Качественные компоненты, полная кастомизация |
| **Формы/валидация** | React Hook Form + Zod | Zod-схемы шарятся между фронтом и бэком |
| **Календарь** | FullCalendar | Зрелая библиотека, drag-and-drop |
| **Монорепо** | Turborepo | Быстрые билды, кэширование |
| **Контейнеризация** | Docker + Docker Compose | Локальная разработка и деплой |

---

## Структура проекта (Turborepo monorepo)

```
autoservice-platform/
├── docker/
│   ├── Dockerfile.api
│   ├── Dockerfile.web
│   ├── docker-compose.yml
│   └── docker-compose.prod.yml
├── packages/
│   ├── shared/                  # Zod-схемы, типы, константы (роли, статусы)
│   └── ui/                      # Общие UI-компоненты (опционально)
├── apps/
│   ├── api/                     # NestJS backend
│   │   ├── prisma/schema.prisma
│   │   └── src/
│   │       ├── common/          # Guards, decorators, middleware, interceptors
│   │       ├── modules/         # auth, tenants, users, vehicles, booking,
│   │       │                    # work-orders, inventory, finance, platform-admin
│   │       ├── database/        # Prisma service с tenant scoping
│   │       └── config/
│   └── web/                     # Next.js frontend
│       └── src/app/
│           ├── (auth)/          # Login, register
│           ├── (admin)/         # Панель для персонала СТО
│           ├── (client)/        # Личный кабинет клиента
│           └── (superadmin)/    # Управление платформой
├── turbo.json
└── package.json
```

---

## Роли и RBAC

| Роль | Область |
|------|---------|
| **SUPERADMIN** | Управление тенантами, биллинг, настройки платформы |
| **OWNER** | Полный доступ к своему СТО, финансы, настройки |
| **MANAGER** | Расписание, назначение работ, отчёты |
| **RECEPTIONIST** | Приём авто, создание заказ-нарядов, запись клиентов |
| **MECHANIC** | Свои заказ-наряды, логирование работ, просмотр склада |
| **CLIENT** | Запись, свои авто, история заказов |

Авторизация через JWT (access 15min + refresh 7d в httpOnly cookie). Tenant определяется из JWT-токена. Prisma client extensions автоматически фильтруют данные по `tenantId`.

---

## Основные сущности БД

- **Tenant** — СТО (name, slug, settings, plan)
- **User** — все роли в одной таблице, `@@unique([email, tenantId])`
- **Vehicle** — авто клиента (make, model, year, VIN, пробег)
- **Service** — каталог услуг (название, цена, длительность, нормо-часы, уровень сложности, тип: планирование/производство/оба)
- **RepairType** — вид ремонта (платный, гарантийный, внутренний) — влияет на финансы и зарплату
- **ServiceBay** — рабочие посты/подъёмники
- **Appointment** — запись на обслуживание + причина обращения, рекламный канал (статусы: pending → confirmed → in_progress → completed/cancelled)
- **WorkOrder** — заказ-наряд + вид ремонта, жалобы клиента, диагностика (10 статусов: NEW → DIAGNOSED → APPROVED → IN_PROGRESS → COMPLETED → INVOICED → PAID → CLOSED)
- **WorkOrderItem** — позиции заказ-наряда (работы + запчасти, нормо-часы)
- **WorkLog** — логи работ механика (часы, описание)
- **Part** — запчасти на складе (SKU, цены, остаток, мин. запас)
- **StockMovement** — движение запчастей (закупка, расход, возврат, корректировка)
- **PurchaseOrder** — заказ поставщику
- **Transaction** — финансовые операции (доход/расход, привязка к заказ-наряду)

### Инсайты из анализа конкурентов (5S AUTO + STOCRM)

Учтено в схеме на основе анализа 5S AUTO и STOCRM:

**Заказ-наряды и работы:**
- **Виды ремонта** (платный/гарантийный/внутренний) — сущность RepairType, привязка к WorkOrder. Влияет на расчёт выручки и зарплат.
- **Нормо-часы и сложность работ** — поля в Service, основа для расчёта зарплаты механикам по выработке.
- **Типы работ** (планирование vs производство) — одни работы для записи, другие для заказ-наряда. Поле `serviceUsage` в Service.
- **Жалобы клиента + диагностика механика** в WorkOrder — два разных текстовых поля.
- **Автоматический расчёт стоимости** — при добавлении работ и запчастей в заказ-наряд сумма считается автоматически.

**Склад и запчасти:**
- **Автоматическое резервирование** запчастей при добавлении в заказ-наряд — статус RESERVED у StockMovement.
- **Аналоги запчастей** — таблица PartAnalog для связи взаимозаменяемых деталей.
- **Гибкие наценки** — возможность устанавливать разные наценки по категориям/поставщикам.
- **Интеграция с каталогами** (будущее) — поля oemNumber, brand готовы для привязки к внешним каталогам.

**CRM и коммуникации:**
- **Автоматическое создание сделки** при любом обращении (звонок, сайт, приложение) — чтобы не терять клиентов.
- **Причина обращения и рекламный канал** в Appointment — для маркетинговой аналитики.
- **Kanban-доска** для заказ-нарядов — наглядное управление потоком работ.
- **Бонусная программа** (будущее) — заложить поле `bonusPoints` в User/Tenant settings.

**Контроль и отчётность:**
- **Контроль нормо-часов** — автоматический расчёт нормативного vs фактического времени.
- **Загрузка постов** — календарь показывает занятость каждого рабочего поста.

---

## API — REST + OpenAPI

Все эндпоинты под `/api/v1/`. Пагинация: `?page=1&limit=20&sort=createdAt&order=desc`.

Ключевые группы:
- `/auth/*` — регистрация, логин, refresh, сброс пароля
- `/platform/tenants` — CRUD тенантов (superadmin)
- `/users` — управление персоналом и клиентами
- `/services` — каталог услуг
- `/vehicles` — автомобили клиентов
- `/appointments` — запись, календарь, свободные слоты
- `/work-orders` — заказ-наряды, позиции, запчасти, логи работ
- `/parts` — каталог запчастей, остатки, корректировки
- `/purchase-orders` — заказы поставщикам
- `/transactions` — финансовые операции
- `/reports/*` — выручка, зарплата механикам, стоимость склада, сводка

---

## Фазы реализации

### Фаза 1 — Фундамент
- Scaffold: Turborepo, NestJS, Next.js, Docker Compose (Postgres + Redis)
- Prisma-схема, миграции, seed
- Auth: register, login, refresh, logout
- Tenant CRUD (superadmin), User CRUD (owner создаёт персонал)
- RBAC guards + tenant scoping middleware
- Базовый layout админки с навигацией
- Страницы логина/регистрации

### Фаза 2 — Запись клиентов
- CRUD каталога услуг и рабочих постов
- CRUD автомобилей
- Запись на обслуживание (визард для клиента)
- Расчёт свободных слотов
- Календарь для персонала (FullCalendar)
- Управление статусами записей
- Личный кабинет клиента: мои авто, мои записи

### Фаза 3 — Заказ-наряды
- CRUD заказ-нарядов с автонумерацией
- Конвертация записи в заказ-наряд
- State machine статусов с валидацией переходов
- Позиции: услуги (работы) и запчасти
- Назначение механика
- Вид механика: "Мои заказы"
- Логирование работ (время, описание)
- Kanban-доска по статусам
- Клиентский вид: отслеживание статуса

### Фаза 4 — Склад
- CRUD каталога запчастей
- Учёт остатков через журнал движений
- Автоматическое списание при добавлении запчасти в заказ-наряд
- Оповещение о низком остатке
- Ручные корректировки
- Заказы поставщикам: создание, приёмка, обновление остатков

### Фаза 5 — Финансы и аналитика
- Автоматическое создание транзакций при оплате заказ-нарядов
- Ручной ввод доходов/расходов
- Дашборд: выручка, воронка заказов, средний чек, топ услуг, загрузка механиков
- Отчёты: выручка за период, зарплата механикам, стоимость склада, история клиента
- Экспорт в CSV

### Фаза 6 — Полировка
- Error handling, валидация, edge cases
- Loading/empty/error states в UI
- Адаптивная вёрстка
- Оптимизация запросов
- Безопасность: CORS, rate limiting, sanitization
- Docker production builds
- Документация (Swagger, README)

---

## MVP = Фазы 1 + 2 + 3

**Включено**: мультитенантный auth, каталог услуг, запись клиентов с календарём, полный цикл заказ-нарядов, назначение механиков, личный кабинет клиента.

**Отложено**: склад (запчасти добавляются как текстовые позиции), финансовые отчёты, закупки, уведомления, оплата онлайн, мобильное приложение.

**Обоснование**: ключевая ценность для СТО — принять запись, создать заказ-наряд, назначить механика, отследить выполнение. Это уже значительное улучшение по сравнению с бумагой/Excel.

---

## Анализ мировых лидеров (бенчмарки)

### Топ-5 мировых систем для автосервисов

| Система | Страна | Цена | Главная фишка |
|---------|--------|------|---------------|
| **Tekmetric** | США | ~$199/мес | 13000+ сервисов, AI-рецепционист (через партнёра), 70+ интеграций |
| **Shop-Ware** | США | $249-799/мес | DVX (цифровой осмотр с rich media), AI Parts Matrix (автоценообразование) |
| **Shopmonkey** | США | $199/мес | Лучший UX, мобильное приложение для механиков, VIN/госномер сканер |
| **AutoLeap** | США | $179/мес | AI-рецепционист 24/7 (AutoLeap AIR), 1300% ROI за первый год |
| **TechMan** | UK | По запросу | Создан гаражом для гаражей, интеграция с AutoData/Haynes Pro |

### Cutting-edge фичи, которые стоит заложить

**1. Цифровой осмотр автомобиля (DVI / DVX)**
- Механик фотографирует/снимает видео проблемных мест
- Клиент получает наглядный отчёт с фото/видео
- Увеличивает одобрение ремонтов на 30-50%
- **Наш план:** модуль VehicleInspection с фото, видео, чек-листами, отправкой клиенту

**2. AI-рецепционист / автоответчик**
- AutoLeap AIR: принимает звонки 24/7, создаёт записи, отвечает на вопросы
- **Наш план (будущее):** интеграция с AI-чатом для онлайн-записи

**3. AI Parts Matrix (автоценообразование запчастей)**
- Shop-Ware: AI анализирует продажи и автоматически оптимизирует наценки
- **Наш план (будущее):** алгоритм рекомендации наценок на основе истории продаж

**4. Text-to-Pay (оплата по SMS)**
- Клиент получает ссылку на оплату в SMS
- **Наш план (будущее):** интеграция с платёжными системами

**5. Canned Jobs (шаблоны работ)**
- Предзаготовленные комплекты работ + запчастей для типовых операций
- Shop-Ware ранжирует по частоте использования для конкретной модели авто
- **Наш план:** сущность ServiceTemplate — шаблоны с набором работ + запчастей

**6. Real-time workflow dashboard**
- Цветовая кодировка статусов заказ-нарядов на одном экране
- % выполнения работ, оплачиваемые часы, ожидание запчастей
- **Наш план:** Kanban-доска с цветами + метрики в реальном времени

**7. Мобильное приложение для механиков**
- Сканирование VIN/госномера камерой
- Фото/видео при осмотре
- Учёт времени (clock in/out по заказ-наряду)
- **Наш план (будущее):** PWA или React Native приложение для механиков

**8. Двусторонняя коммуникация с клиентом**
- Чат/SMS прямо из карточки заказ-наряда
- Клиент одобряет смету в один клик
- **Наш план:** встроенный чат + одобрение сметы через ссылку

**9. Multi-location (мультифилиальность)**
- Один тенант может иметь несколько филиалов с общей аналитикой
- **Наш план:** поле `branchId` в Tenant settings, расширяемо

**10. Управление загрузкой (Capacity Management)**
- Система знает сколько постов/механиков свободно и не даёт перебукировать
- **Наш план:** ServiceBay + календарь загрузки с валидацией слотов

---

## Регламенты OneMotors (первый клиент / тестовая площадка)

Изучены 3 реальных документа: чек-лист приёмщика, скрипты общения, регламент работы.

### Бизнес-процесс приёмки (КРИТИЧНО — заложить в систему)

**Поток: приём -> диагностика -> согласование -> работа -> выдача -> follow-up**

1. **Приём авто** (до 10 мин)
   - Фиксация: ФИО, телефон, канал связи (звонок/WhatsApp), госномер, VIN, пробег, уровень топлива, источник клиента (откуда пришёл лид)
   - **Фотофиксация**: 6+ ракурсов кузова, салон, одометр, проблемный узел — обязательно
   - Жалоба клиента (текст)
   - Чехлы/коврик -> отметка
   - Подпись клиента (акт приёма-передачи)

2. **Диагностика**
   - Задание механику с чек-листом
   - По завершении -> связь с клиентом: перечень работ, бюджет, срок
   - **Первичные рекомендации** (сделать сейчас) + **вторичные** (отложить на будущее)

3. **Согласование**
   - Клиент подтверждает объём и стоимость
   - **При изменении цены >5%** — обязательное повторное согласование (фиксация в ЗН: дата/время/канал/ФИО)
   - Варианты: полный объём или разбивка на этапы

4. **Работа**
   - Контроль сроков
   - При ремонтах >1 дня — ежедневный фото/видеоапдейт клиенту

5. **Контроль качества и выдача**
   - Финальная проверка качества
   - Показать заменённые детали
   - Озвучить гарантию
   - Тест-драйв (если работы на управляемость/тормоза) — маршрут 2-5 км
   - «Чистые руки» — авто без следов работ

6. **Follow-up (через 2 дня)**
   - Звонок/мессенджер: всё ли ок?
   - Напомнить о вторичных рекомендациях
   - Предложить дату следующего визита
   - Коды результата: DONE / RESCHED / DECLINE / NO-ANSWER

### 4 обязательных статуса клиенту (мессенджер)

Система должна автоматически/полуавтоматически отправлять через абстрактный **MessagingProvider** (не привязываемся к конкретному мессенджеру):
1. **Принятие** — «Ваш автомобиль принят. Жалобы: [...]. Начинаем диагностику»
2. **Диагностика** — «Завершили. Перечень: [...]. Бюджет [...]. Срок [...]. Прошу согласовать»
3. **Согласование** — «Запускаем работы: [...]. При изменении >5% — уточним»
4. **Готовность** — «Работы завершены. Выдача до [время]. Ждём вас»

**Каналы доставки** (выбирается в настройках тенанта + предпочтение клиента):
- WhatsApp (через Wazzup / Mango Диалоги)
- Telegram (через Bot API)
- SMS (через SMS.ru / SMSC)
- Email (запасной вариант)

Архитектура: интерфейс `MessagingProvider` с реализациями для каждого канала. Клиент в карточке указывает предпочтительный канал. Система пробует по приоритету: выбранный канал -> SMS -> email.

### KPI мастера-приёмщика (система должна считать автоматически)

| KPI | Порог | Формула |
|-----|-------|---------|
| Полнота карточки клиента | >90% | ЗН с полной карточкой / все ЗН |
| SLA по статусам | >90% | ЗН с 4 статусами в срок / все ЗН |
| Качество рекомендаций | >90% | ЗН с рекомендациями по стандарту / все ЗН |
| Корректность согласований | >90% | ЗН со сметами по стандарту / все ЗН |
| Follow-up после выдачи | >90% | Выданные авто с кодом результата в срок / все выданные |

**Штраф до 25 000 руб** при невыполнении любого KPI.

### Мотивация (расчёт зарплаты — система должна считать)

- **Оклад:** 50 000 руб
- **Процент от маржи** (работы + запчасти) за месяц:

| Маржа за месяц | Ставка |
|----------------|--------|
| До 800 000 | 0% |
| 800 001 - 1 000 000 | 3% |
| 1 000 001 - 1 200 000 | 4% |
| 1 200 001 - 1 500 000 | 5% |
| > 1 500 001 | 6% |

### Что это значит для системы — новые требования

1. **Фотофиксация при приёмке** — обязательные поля: минимум 6 фото кузова + одометр + проблемный узел. Хранение в S3.
2. **Чек-лист приёмщика** — цифровой, с чекбоксами: фото, чехлы, карточка, диагн., реком., статусы, КК, оплата, follow-up
3. **Автоматическая отправка статусов** в мессенджер (WhatsApp/Telegram/SMS — абстрактный MessagingProvider) по шаблонам при смене статуса ЗН
4. **Поле «источник клиента»** в Appointment/WorkOrder — для маркетинговой аналитики
5. **Первичные + вторичные рекомендации** — отдельные сущности, привязанные к WorkOrder, с полями: описание, фото/видео, срок/пробег, статус (выполнено/перенесено/отказ)
6. **Правило >5% изменения цены** — валидация в системе: если итог меняется >5% от согласованного — блокировка до повторного подтверждения клиентом
7. **KPI дашборд** — автоматический расчёт всех 5 KPI для каждого приёмщика
8. **Расчёт зарплаты** — автоматический расчёт маржи по ЗН приёмщика + процент по ступеням
9. **Follow-up задачи** — автоматическое создание задачи «позвонить клиенту через 2 дня» после выдачи
10. **Скрипты/шаблоны** — встроенные шаблоны сообщений с плейсхолдерами (канал-агностичные, работают в любом мессенджере)

---

### Ключевые метрики конкурентов (бенчмарки)

- **89% approval rate** (Shop-Ware) — одобрение ремонтов с DVI
- **30% рост выручки** (AutoLeap) — после внедрения CRM
- **50% экономия времени** на коммуникацию с клиентами (AutoLeap)
- **$199-249/мес** — типичная цена entry-level плана
- **13000+ сервисов** (Tekmetric) — масштаб лидера рынка

---

## Дополнительные модули

### IP-телефония

**Задача:** входящие/исходящие звонки из CRM, запись разговоров, всплывающая карточка клиента при звонке, история звонков.

**Архитектура:**
- Абстрактный интерфейс `TelephonyProvider` — позволяет подключать разных провайдеров
- На старте: интеграция с **Mango Office** (крупнейший SIP-провайдер в РФ, 300+ интеграций, открытый API)
- Альтернативы для будущего: Sipuni, UIS, Zadarma, Asterisk (self-hosted)

**Ключевые фичи:**
- Входящий звонок -> автоопределение клиента по номеру -> всплывающая карточка с историей
- Click-to-call из карточки клиента/заказ-наряда
- Запись разговоров с привязкой к сделке/заказ-наряду
- Автоматическое создание записи (Appointment) при звонке нового клиента
- Статистика звонков: пропущенные, среднее время ответа, загрузка операторов

**Сущности БД:**
- `CallRecord` — запись звонка (direction, duration, recordingUrl, userId, clientId, appointmentId, workOrderId)
- `TelephonySettings` — настройки провайдера для тенанта (provider, apiKey, apiSecret)

**API эндпоинты:**
- `POST /api/v1/telephony/webhook` — вебхук от провайдера (входящий/исходящий/завершён)
- `POST /api/v1/telephony/call` — инициировать звонок
- `GET /api/v1/calls` — история звонков с фильтрами
- `GET /api/v1/calls/:id/recording` — запись разговора

---

### AI-консьерж (чат-бот с ИИ)

**Задача:** AI-ассистент общается с клиентами в стиле менеджера/оператора — отвечает на вопросы, записывает на сервис, сообщает статус ремонта, отправляет напоминания.

**Архитектура:**
- Модуль `ai-concierge` с интеграцией через LLM API (OpenAI / Anthropic / YandexGPT)
- Контекст: данные тенанта (услуги, цены, расписание, статусы заказов клиента)
- Каналы: виджет на сайте, Telegram-бот, WhatsApp (через Mango Диалоги / Wazzup)

**Сценарии работы:**
1. **Онлайн-запись:** клиент пишет -> бот уточняет авто, услугу, удобное время -> создаёт Appointment
2. **Статус ремонта:** «Что с моей машиной?» -> бот находит активный WorkOrder -> отвечает статус и прогноз
3. **Ответы на вопросы:** цены, график работы, акции, адрес — из настроек тенанта
4. **Напоминания:** за день до записи, после завершения ремонта (оценка качества)
5. **Эскалация:** если бот не может ответить -> передаёт живому менеджеру с контекстом

**Сущности БД:**
- `ChatConversation` — диалог (channel, clientId, status: active/closed/escalated)
- `ChatMessage` — сообщение (conversationId, role: client/bot/operator, content)
- `AiConciergeSettings` — настройки бота для тенанта (prompt, llmProvider, channels, businessInfo)

**API эндпоинты:**
- `POST /api/v1/chat/message` — отправить сообщение боту
- `GET /api/v1/chat/conversations` — список диалогов (для оператора)
- `POST /api/v1/chat/conversations/:id/escalate` — передать оператору
- `POST /api/v1/chat/webhook/:channel` — вебхук от мессенджеров

---

### Онлайн-касса (54-ФЗ)

**Задача:** фискализация всех расчётов в соответствии с 54-ФЗ — формирование чеков, передача в ОФД, отправка электронных чеков клиентам.

**Требования 54-ФЗ (актуальные на 2026):**
- ККТ зарегистрирована в ФНС, подключена к ОФД
- Электронный чек отправляется клиенту (email/SMS или через «Мои чеки онлайн»)
- НДС 22% с 01.01.2026
- Поддержка ФФД 1.2 (формат фискальных документов)
- Маркировка товаров (Честный Знак) — если СТО продаёт маркированные запчасти

**Архитектура:**
- Абстрактный интерфейс `FiscalProvider` — для подключения разных кассовых сервисов
- На старте: интеграция с **АТОЛ Онлайн** (облачная касса, REST API, JSON, UTF-8)
- Альтернативы: Эвотор, МодульКасса, Ferma (OFD.ru), Orange Data

**Как работает:**
1. Клиент оплачивает заказ-наряд (наличные / карта / СБП / онлайн)
2. Система формирует запрос к АТОЛ Онлайн с данными чека:
   - Позиции (работы + запчасти), количество, цена, НДС
   - Способ оплаты (наличные, безнал, предоплата)
   - Email/телефон клиента для отправки чека
3. АТОЛ Онлайн фискализирует чек -> передаёт в ОФД -> ОФД передаёт в ФНС
4. Клиент получает электронный чек

**Сущности БД:**
- `FiscalReceipt` — фискальный чек (workOrderId, transactionId, receiptType: sale/refund, fiscalNumber, fiscalSign, ofdUrl, status)
- `FiscalSettings` — настройки кассы для тенанта (provider, groupCode, innOrg, paymentAddress, callbackUrl)

**API эндпоинты:**
- `POST /api/v1/fiscal/receipt` — создать и отправить чек
- `GET /api/v1/fiscal/receipts` — история чеков
- `POST /api/v1/fiscal/webhook` — callback от АТОЛ Онлайн (статус фискализации)
- `POST /api/v1/fiscal/receipt/:id/refund` — чек возврата

**Типы чеков:**
- Приход (продажа услуг/запчастей)
- Возврат прихода (возврат денег клиенту)
- Предоплата (аванс)
- Зачёт предоплаты

---

## Обновлённые фазы реализации

Три новых модуля добавляются как **Фаза 7** (после полировки):

### Фаза 7a — Онлайн-касса (приоритет — обязательно по закону)
- Интерфейс FiscalProvider + реализация для АТОЛ Онлайн
- Фискализация при оплате заказ-наряда
- Чеки продажи и возврата
- Настройки кассы в админке тенанта
- Печать/отправка чеков клиенту

### Фаза 7b — IP-телефония
- Интерфейс TelephonyProvider + реализация для Mango Office
- Вебхук входящих звонков -> определение клиента
- Click-to-call из интерфейса
- Запись звонков, история, привязка к сделкам
- Настройки телефонии в админке

### Фаза 7c — AI-консьерж
- Модуль чата с LLM-интеграцией
- Виджет на сайте (встраиваемый)
- Telegram-бот
- Сценарии: запись, статус, FAQ
- Эскалация на оператора
- Панель оператора для мониторинга диалогов

---

## Инфраструктура и деплой (Россия)

### Юридические требования

**152-ФЗ (персональные данные):**
- Все ПДн граждан РФ **обязаны храниться на серверах в России** (первичный сбор и хранение)
- С 01.07.2025 — запрет на первичную запись ПДн в иностранные хранилища
- С 01.09.2025 — отдельный документ согласия на обработку ПДн
- Штрафы: юрлица — **3-15 млн руб.** за незаконную трансграничную передачу
- Роскомнадзор с 2026 проводит массовые автоматические проверки

**54-ФЗ (кассы):** облачная касса и ОФД тоже в РФ — обеспечено АТОЛ Онлайн.

**Вывод:** Vercel, AWS, GCP, Netlify — **не подходят** как основной хостинг. Все данные и серверы должны быть в российских ЦОД.

### Рекомендуемый провайдер: Selectel

| Параметр | Значение |
|----------|---------|
| ЦОДы | Москва, СПб, Новосибирск (Tier III) |
| SLA | 99.98% |
| Сервисы | VPS, Kubernetes, S3 (объектное хранилище), CDN, managed PostgreSQL, managed Redis |
| 152-ФЗ | Полное соответствие, есть решение «Облако 152-ФЗ» |
| Цена | От ~2000 руб/мес за VPS, managed DB — от ~3000 руб/мес |

**Альтернативы:** Timeweb Cloud, REG.RU (reg.cloud), RocketCloud

### Selectel сервер (создан)

- **Имя:** STO
- **Регион:** Санкт-Петербург / ru-3b
- **ID:** 88138cb0-1725-4904-8f24-6a055568e2c6
- **ОС:** Ubuntu 24.04 LTS
- **Конфиг:** Standard, AMD, 4 vCPU (выделенные ядра), 16 ГБ RAM
- **Диск:** 80 ГБ, Универсальный SSD
- **Сеть:** приватная 192.168.0.223, публичный IP 178.72.139.156
- **SSH-ключ:** Lucinda
- **Цена:** 8 129 руб/мес

### Архитектура деплоя

```
Selectel Cloud (СПб)
├── Docker Compose на VPS
│   ├── api (NestJS)
│   ├── web (Next.js)
│   ├── PostgreSQL 16
│   ├── Redis 7
│   └── nginx — reverse proxy + SSL
├── S3-хранилище — фото/видео (DVI, чаты), файлы, бэкапы
└── CDN — статика фронтенда (позже)
```

### Масштабирование (рост)

```
Selectel Managed Kubernetes
├── API pods (auto-scaling)
├── Web pods (auto-scaling)
├── Worker pods (BullMQ jobs)
├── Managed PostgreSQL (primary + replica)
├── Managed Redis (cluster)
├── S3 + CDN
└── Мониторинг: Grafana + Prometheus
```

### Сервисы, которые НЕ использовать (не работают в РФ / не соответствуют 152-ФЗ)

| Сервис | Причина |
|--------|---------|
| Vercel | Серверы за рубежом, не работает в РФ |
| Netlify | Серверы за рубежом |
| AWS / GCP / Azure | Нет ЦОД в РФ, 152-ФЗ |
| Supabase | Серверы за рубежом |
| PlanetScale | Серверы за рубежом |
| Firebase | Google, серверы за рубежом |

### Российские аналоги зарубежных сервисов

| Нужен | Зарубежный | Российский аналог |
|-------|-----------|-------------------|
| Хостинг/VPS | AWS EC2 | Selectel, Timeweb Cloud |
| Managed PostgreSQL | AWS RDS | Selectel Managed DB |
| Объектное хранилище | AWS S3 | Selectel S3, REG.RU S3 |
| CDN | CloudFront | Selectel CDN, CDNvideo |
| Email-рассылки | SendGrid | UniSender, SendPulse |
| SMS | Twilio | SMS.ru, SMSC.ru, Mango Office |
| Аналитика | Google Analytics | Яндекс.Метрика |
| Платежи | Stripe | ЮKassa, Robokassa, СБП |
| Касса | — | АТОЛ Онлайн, Эвотор |
| Телефония | Twilio | Mango Office, Sipuni, UIS |
| Чат-боты/мессенджеры | Intercom | Carrot quest, JivoSite |
| CI/CD | GitHub Actions | GitLab CI (self-hosted) или GitHub Actions* |

*GitHub Actions допустим для CI/CD, т.к. код — не персональные данные. Но артефакты и секреты хранить в РФ.

---

## Локализация (русский язык)

Всё, что видит пользователь — на русском языке. Код остаётся на английском.

**На русском:**
- Весь UI: кнопки, меню, заголовки, подсказки, placeholder'ы
- Сообщения об ошибках API (валидация, бизнес-логика)
- Swagger-документация (описания эндпоинтов)
- Email/уведомления (в будущем)
- Статусы в человекочитаемом виде (например, `NEW` в БД -> «Новый» в UI)

**На английском:**
- Код: переменные, функции, классы
- API endpoints (`/api/v1/work-orders`, не `/api/v1/заказ-наряды`)
- Enum-значения в БД (`NEW`, `IN_PROGRESS`)
- Имена таблиц и колонок в Prisma

**Реализация:** файл `packages/shared/src/i18n/ru.ts` — словарь всех строк. Фронтенд берёт строки из словаря. Бэкенд возвращает ошибки через словарь. Это упрощает будущую мультиязычность (если понадобится).

---

## Верификация

- `docker compose up` — полный стек поднимается локально
- Seed создаёт демо-тенант с тестовыми данными по всем ролям
- E2E: клиент записывается -> приёмщик подтверждает -> создаёт заказ-наряд -> механик берёт в работу -> завершает -> приёмщик закрывает
- Swagger UI на `/api/docs` для тестирования API
- Проверка изоляции: данные одного тенанта недоступны другому
